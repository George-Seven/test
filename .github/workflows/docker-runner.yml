name: Docker Runner
on:
  workflow_dispatch:

concurrency:
  group: docker-runner
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Docker Runner
        run: |
          sudo npm install -g localtunnel
          sudo sed -i -E 's|ExecStart=/usr/bin/dockerd.*|ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375|g' /lib/systemd/system/docker.service
          sudo systemctl daemon-reload
          sudo systemctl restart docker
          get_tcp_url(){
          unset tcp_url && \
          tcp_url=$(expect -c '
          log_user 0
          spawn ssh -T -p 443 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -R 0.0.0.0:2375:localhost:2375 tcp@a.pinggy.io
          expect -re {tcp://.*} {
              set result $expect_out(0,string)
              puts $result
          }
          exec sleep infinity
          ' | tee /tmp/ssh_output.txt) & \
          sleep 2 && \
          tcp_url=$(grep -o 'tcp://.*' /tmp/ssh_output.txt) && \
          echo "$tcp_url"
          }
          
          while true; do
              echo "Starting tcp tunnel..."
              ntfy publish "$TUNNEL_SECRET" "$(get_tcp_url)"
              sleep 50m
          done
